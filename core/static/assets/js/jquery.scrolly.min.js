(function ($) {
    function calculateScrollPosition(target, options) {
        var $target = $(target), position;

        if ($target.length === 0) return null;

        position = $target.offset().top;

        switch (options.anchor) {
            case "middle":
                position -= ($(window).height() - $target.outerHeight()) / 2;
                break;
            default:
                position = Math.max(position, 0);
        }

        if (typeof options.offset === "function") {
            position -= options.offset();
        } else {
            position -= options.offset;
        }

        return position;
    }

    $.fn.scrolly = function (options) {
        var $this = $(this);

        if ($this.length === 0) return $this;
        if ($this.length > 1) {
            $this.each(function () {
                $(this).scrolly(options);
            });
            return $this;
        }

        var target = $this.attr("href");
        if (target.charAt(0) !== "#" || target.length < 2) return $this;

        options = $.extend({
            anchor: "top",
            easing: "swing",
            offset: -100,
            parent: $("body,html"),
            pollOnce: false,
            speed: 1000
        }, options);

        var scrollPosition = null;
        if (options.pollOnce) {
            scrollPosition = calculateScrollPosition(target, options);
        }

        $this.off("click.scrolly").on("click.scrolly", function (event) {
            var position = scrollPosition !== null ? scrollPosition : calculateScrollPosition(target, options);
            if (position !== null) {
                event.preventDefault();
                options.parent.stop().animate({ scrollTop: position }, options.speed, options.easing);
            }
        });

        return $this;
    };
})(jQuery);
